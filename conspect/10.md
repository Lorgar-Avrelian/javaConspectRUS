# 10 Логирование и конфигурирование приложений

> [[_оглавление_]](../README.md/#10-логирование-и-конфигурирование-приложений)

## 10.1 Логирование

> [[_оглавление_]](../README.md/#101-логирование)

[**Логирование**](/conspect/definitions.md/#л) - это процесс записи и вывода информации о поведении программы в момент
её выполнения.

[**Лог (лог-файл)**](/conspect/definitions.md/#л) - это файл, куда производится запись информации о ходе работы
приложения.

У одного приложения может быть несколько лог-файлов с разными названиями: в зависимости от настроек логирования, данные
для различных профилей или различных режимов работы могут сохраняться в разные лог-файлы.  
В одном лог-файле находится множество записей, где каждая строчка содержит отдельные результаты для каждого
взаимодействия с программой.

Библиотеки для логирования в Java:

* _Apache Log4j_ - первая выпущенная библиотека для логирования (имеет две версии, которые между собой несовместимы);
* _JUL_ - java.util.logging - уровни логирования отличаются от того, что есть в _Logback_, _Log4j_ и _Slf4j_, поэтому
  используется крайне редко;
* _JCL_ - jakarta commons logging - обёртка для библиотек логирования с малой функциональностью, поэтому используется
  крайне редко;
* _Logback_ - стал преемником _Log4j_ с улучшенной производительностью, поддержкой _SLF4J_ и расширенными опциями
  фильтрации (самая популярная библиотека);
* _SLF4J_ - simple logging facade for java - является обёрткой для библиотек логирования с расширенной
  функциональностью.

В _Spring Boot_ по умолчанию используется связка _SLF4J_ как интерфейса логирования и _Logback_ как библиотеки для
записи логов.

Для добавления реализации библиотеки логирования в класс нужно воспользоваться статическим методом `getLogger()` класса
_LoggerFactory_, в который необходимо передать логируемый класс.

Пример использования:

```java
public class ExpensesController {
    Logger logger = LoggerFactory.getLogger(ExpensesController.class);
}
```

### 10.1.1 Уровни логирования

> [[_оглавление_]](../README.md/#101-логирование)

Чтобы контролировать и фильтровать объёмы записываемой информации, придумали различные уровни логирования.

Уровни логирования:

- <font color="Purple">**ALL**</font> - выводится вся информация;
- <font color="Blue">**TRACE**</font> - информация для точной отладки;
- <font color="Aqua">**DEBUG**</font> - выводится информация, которая пригодится для отладки программы;
- <font color="Green">**INFO**</font> - обычные и стандартные сообщения;
- <font color="Orange">**WARN**</font> - нефатальное предупреждение;
- <font color="Red">**ERROR**</font> - записи ошибок;
- <font color="Maroon">**FATAL**</font> - фатальная ошибка;
- <font color="Gray">**OFF**</font> - сообщения не выводятся.

Уровни логирования имеют следующее соотношение важности:

```text
TRACE < DEBUG < INFO < WARN < ERROR
```

При выставлении уровня логирования будут выводиться все сообщения этого уровня и выше.

Логирование с требуемым уровнем логирования можно вызывать в самом коде:

```java
public void loggerExample() {
    Logger logger = LoggerFactory.getLogger(Main.class);
    logger.trace("Trace message"); // вывод сообщения с уровнем TRACE
    logger.debug("Debug message"); // вывод сообщения с уровнем DEBUG
    logger.info("Info message");   // вывод сообщения с уровнем INFO
    logger.warn("Warn message");   // вывод сообщения с уровнем WARN
    logger.error("Error message"); // вывод сообщения с уровнем ERROR
}
```

По умолчанию для приложения применяется уровень логирования **INFO**.  
Для изменения уровня логирования для всего приложения необходимо задать значение `logging.level` в файле
_application.properties_. При этом, задавать уровень логирования можно, задавая конкретный _scope_ его применения:

- для всего приложения:

```properties
logging.level.root=DEBUG
```

- для конкретного пакета приложения:

```properties
logging.level.org.springframework.web=TRACE
logging.level.lorgar.avrelian.javaconspectrus.services.implementations=INFO
```

### 10.1.2 Логи

> [[_оглавление_]](../README.md/#101-логирование)

Стандартные лог-сообщения выводятся в следующем формате:

```text
[дата и время][уровень логирования][PID процесса][---][название потока][класс, из которого выводится сообщение][:][сообщение]
```

Например:

```text
2022-03-15 23:45:42.705 TRACE 1898 —- [nio-8080-exec-8] l.a.j.s.i.ManageServiceImpl : Trace message 
2022-03-15 23:45:42.705 DEBUG 1898 —- [nio-8080-exec-8] l.a.j.s.i.ManageServiceImpl : Debug message 
2022-03-15 23:45:42.705 INFO  1898 —- [nio-8080-exec-8] l.a.j.s.i.ManageServiceImpl : Info message 
2022-03-15 23:45:42.705 WARN  1898 —- [nio-8080-exec-8] l.a.j.s.i.ManageServiceImpl : Warn message 
2022-03-15 23:45:42.705 ERROR 1898 —- [nio-8080-exec-8] l.a.j.s.i.ManageServiceImpl : Error message
```

### 10.1.3 Appenders

> [[_оглавление_]](../README.md/#101-логирование)

Интерфейс _Appenders_ предназначен для управления тем, куда будут записываться логи приложения.

Для организации записи и отправки логов в конкретные ресурсы применяются различные реализации интерфейса _Appenders_:

- _ConsoleAppender_ - выводит сообщения в консоль;
- _DBAppender_ - пишет сообщения в БД;
- _FileAppender_ - пишет сообщения в файл;
- _DailyRollingFileAppender_ - пишет сообщения в файл;
- _JDBCAppender_ - пишет сообщения в БД;
- _TelnetAppender_ - передаёт сообщения через _TCP/IP_;
- _AsyncAppender_ - производит асинхронную передачу сообщений.

> [[Ссылка]](https://logging.apache.org/log4j/2.x/manual/appenders.html) на полный перечень и описание реализаций
> интерфейса _Appenders_, а также правила их настройки.

По умолчанию логи выводятся в консоль приложения в соответствии с настроенным уровнем логирования (используется
реализация _ConsoleAppender_).

### 10.1.4 Logback

> [[_оглавление_]](../README.md/#101-логирование)

_Logback_ - один из наиболее широко используемых фреймворков протоколирования в сообществе Java. Он заменяет своего
предшественника _Log4j_.  
_Logback_ предлагает более быструю реализацию, больше возможностей для настройки и большую гибкость в архивировании
старых файлов журналов.

Архитектурно _Logback_ состоит из трёх классов:

- _Logger_ - класс, с которым взаимодействуют приложения для создания сообщений логирования;
- _Appenders_ - интерфейс, реализации которого помещают логи в их конечные пункты назначения;
- _Layout_ - подготавливает логи для вывода.

_Logback_ использует фасад _SLF4J_ в качестве собственного интерфейса.

Настройка _Logback_ выполняется в следующем порядке:

- добавить зависимости в файл:

    * _pom.xml_:
      ```xml
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-core</artifactId>
            <version>1.5.9</version>
        </dependency>
      ```
      ```xml
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>2.1.0-alpha1</version>
        </dependency>
      ```
      ```xml
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
            <version>1.5.9</version>
        </dependency>
      ```
      (опционально)
      ```xml
        <dependency>
              <groupId>org.tuxdude.logback.extensions</groupId>
              <artifactId>logback-colorizer</artifactId>
              <version>1.0.1</version>
        </dependency>
      ```

    * _build.gradle_:
      ```groovy
        implementation 'ch.qos.logback:logback-core:1.5.9'
        implementation 'org.slf4j:slf4j-api:2.1.0-alpha1'
        implementation 'ch.qos.logback:logback-classic:1.5.9'
      ```
      (опционально)
      ```groovy
        implementation 'org.tuxdude.logback.extensions:logback-colorizer:1.0.1'
      ```
- создать конфигурационный файл _logback.xml_, в который внести настройки логирования:

```xml

<configuration>
    <!--    Настройка вывода логов в терминал (консоль)-->
    <!--    Выбор цветовой схемы-->
    <!--    <property scope="context" name="COLORIZER_COLORS" value="red@black,yellow@black,green@black,blue@black,magenta@black" />-->
    <!--    ИЛИ-->
    <property scope="context" name="COLORIZER_COLORS" value="red@,yellow@,green@,blue@,magenta@"/>
    <conversionRule conversionWord="colorize" converterClass="org.tuxdude.logback.extensions.LogColorizer"/>
    <!--    Настройка ConsoleAppender-->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <withJansi>true</withJansi>
        <layout class="ch.qos.logback.classic.PatternLayout">
            <Pattern>
                <!--    Раскрашивание логов с помощью "org.tuxdude.logback.extensions.LogColorizer"            -->
                %colorize(%d{HH:mm:ss.SSS} [%t] %-4relative %-5level %logger{36} - %msg%n)
                <!--    Раскрашивание логов с помощью стандартной библиотеки                                   -->
                <!--    %highlight(%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n)                        -->
            </Pattern>
        </layout>
    </appender>

    <!--    Настройка вывода логов в файл-->
    <!--    Задание директории для лог-файлов-->
    <property name="LOG_DIR" value="logs"/>
    <!--    Настройка FileAppender-->
    <appender name="FILE" class="ch.qos.logback.core.FileAppender">
        <!--    Задание названия файла для сохранения логов-->
        <file>${LOG_DIR}/services.log</file>
        <append>true</append>
        <encoder>
            <pattern>
                %d{yyyy-MM-dd HH:mm:ss} [%t] %-5p %c{1}:%L - %m%n
            </pattern>
        </encoder>
    </appender>

    <!--    Настройка вывода логов в файл с прокруткой-->
    <!--    Задание названий для лог-файлов-->
    <property name="LOG_FILE_WEB" value="web"/>
    <!--    Настройка RollingFileAppender-->
    <appender name="ROLL-FILE-1" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!--    Задание названия файла для сохранения логов-->
        <file>${LOG_DIR}/${LOG_FILE_WEB}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- ежедневная прокрутка -->
            <fileNamePattern>
                ${LOG_FILE_WEB}.%d{yyyy-MM-dd}.gz
            </fileNamePattern>
            <!-- каждый из архивных файлов не больше 10МБ, общий объем истории за 30 дней должен быть ограничен 3 ГБ -->
            <maxFileSize>10MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%-4relative [%thread] %-5level %logger{35} - %msg%n</pattern>
        </encoder>
    </appender>

    <!--    Настройка ещё одного вывода логов в файл с прокруткой-->
    <property name="LOG_FILE_CONTROLLER" value="controller"/>
    <appender name="ROLL-FILE-2" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/${LOG_FILE_CONTROLLER}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>
                ${LOG_FILE_CONTROLLER}.%d{yyyy-MM-dd}.gz
            </fileNamePattern>
            <maxFileSize>10MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>3GB</totalSizeCap>
        </rollingPolicy>
        <encoder>
            <pattern>%-4relative [%thread] %-5level %logger{35} - %msg%n</pattern>
        </encoder>
    </appender>

    <!--    Задание уровня логирования и конкретной реализации интерфейса Appenders для всего приложения-->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
    </root>
    <!--    Задание уровня логирования и конкретной реализации интерфейса Appenders для org.springframework.web-->
    <logger name="org.springframework.web" level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ROLL-FILE-1"/>
    </logger>
    <!--    Задание уровня логирования и конкретной реализации интерфейса Appenders для пакета-->
    <logger name="lorgar.avrelian.javaconspectrus.services.implementations" level="TRACE" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
    </logger>
    <!--    Задание уровня логирования и конкретной реализации интерфейса Appenders для контроллеров-->
    <logger name="lorgar.avrelian.javaconspectrus.controllers" level="TRACE" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ROLL-FILE-2"/>
    </logger>

</configuration>
```   

- внедрить в логируемый класс экземпляр логгера (обратить внимание на импортируемые библиотеки):

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ManageController {
    private Logger logger = LoggerFactory.getLogger(ManageController.class);
}
```
